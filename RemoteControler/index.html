<!DOCTYPE html>
<html>
    <head>
        <title>GMS Panel</title>
        <script src="https://unpkg.com/react@16.7.0/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@16.7.0/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.dev.js"></script>
        <script
            src="https://code.jquery.com/jquery-3.4.1.js"
            integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
            crossorigin="anonymous">
        </script>     
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
        <!-- <script src="https://www.gstatic.com/firebasejs/7.2.2/firebase-app.js"></script> -->
        <script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css"> 
        <!-- <link rel="stylesheet" href="./css/main.css" type="text/css"> -->
        <script type="text/jsx" src="getScreenshot.js"></script>

        <script>

            function lcdDisplay(dataFromtheServer) 
            {
                $("#originaldata").html(dataFromtheServer);
                        
                let data = JSON.parse(dataFromtheServer);
                    
                // console.log(data);            
                console.log(data.length);
                let header_set = false;
                let h = "";
                let v = "";    

                $.each(data, (key, theRow) => {
                    console.log(key + " , " + theRow); 
                    //let number = Math.floor((Math.random() * 2) + 0);
                    
                    if(key == 0)
                    {
                        $.each(theRow, (theKeyInTheRow, theValueInTheRow) => {

                            if(theKeyInTheRow != 'type')
                            {
                                if (!header_set)
                                    h += "<th>" + theKeyInTheRow + "</th>";


                                v += "<tr>" ;
                                v += "<td>" + theValueInTheRow + "</td>";
                                v += "</tr>" ;
                            }
                        });
                                    
                        if (!header_set) {
                            h = "<tr>" + h + "</tr>";
                            header_set = true;
                        }
                    }  
                            
                });

                // disiplayig the data
                $("#result thead > tr").remove();
                $("#result thead").append("<tr><th></th></tr>");
                $("#result tbody > tr").remove();
                $("#result tbody").append(v);
                            
            }

            // display with response object
            function displayHistory(dataFromtheServer) 
            {
                // $("#originaldata").html(dataFromtheServer);
            
                let data = JSON.parse(dataFromtheServer);
                let returnValue = new Array();
                
                let header_set = false;
                let h = "";
                let v = [[0,0], [1,1]]; 
                let checkboxObject = [];   
                let colCount = 0;
                let rowCount = 0;
                let count = 0;

                $.each(data, (key, value) => {

                    // v[count] += "<tr>" ;
                    let check_set = false;
                    let colCount = 0;

                    $.each(value, (key2, value2) => {
                        if(!header_set)
                            h += "<th>" + key2.toUpperCase() + "</th>";
                        
                        if(!check_set)
                        {
                            var checkInput = $(document.createElement('input')).attr({
                                            id:    value2,
                                            name:  value2,
                                            value: value2,
                                            type:  'checkbox'
                            });

                            checkboxObject[count] = checkInput;
                            }
                            
                        // v[rowCount][colCount++] = value2+"";//"<td>" + value2 + "</td>";
                        check_set = true;
                    });
                    
                    if (!header_set) {
                        h += "<th>ACTION</th>";
                        h = "<tr>" + h + "</tr>";
                        header_set = true;
                    }
                    // v[count] += "</tr>" ;
                    // console.log(v[rowCount]);

                    rowCount++;
                });                        

                $("#actionHistory thead > tr").remove();
                $("#actionHistory thead").append(h);
                $("#actionHistory tbody > tr").remove();
               
                $.each(data, (key, value) => {
                    var tr = $("<tr />");

                    $.each(value, (key2, value2) => {
                        tr.append($("<td />", { html: value2 }));
                    });
                    tr.append($("<td />",{ html: '<button class="retry" id ='+ key +'>Retry</button>'}));

                    $("#actionHistory tbody").append(tr);
                });   
                
                $('button.retry').on('click', function(){

                    var cRow = $(this).parents('tr');
                    var category = $('td:nth-child(1)', cRow).text();
                    var type = $('td:nth-child(2)', cRow).text();
                    var param1 = $('td:nth-child(3)', cRow).text();
                    var param2 = $('td:nth-child(4)', cRow).text();
                    var param3 = $('td:nth-child(5)', cRow).text();
                    
                    if(type == 'Start Watering')
                    {
                        let unit = param1;
                        let num = parseInt(param2);
                        alert(num);

                        if(unit == "liter")
                            num = num*60*6;
                        else if(unit == "time")
                            num = num*6;
                        num = Math.ceil(num);

                        $.ajax({
                            url: document.URL.replace("?", "") + 'updateMotor',
                            type: 'POST',
                            success: function(response){
                                successMsg();
                            },
                            data:{
                                cycle: num,
                                status: "on"
                            }
                        });                       
                    }
                    else if(type == 'Stop Watering')
                    {
                        $.ajax({
                            url: document.URL.replace("?", "") + 'updateMotor',
                            type: 'POST',
                            success: function(response){
                                successMsg();
                            },
                            data:{
                                cycle: "0",
                                status: "off"
                            }
                        });
                    }
                    else if(type == 'Send Message')
                    {
                        $.ajax({
                            url: document.URL.replace("?", "") + 'sendMessage',
                            type: 'POST',
                            success: function(response){
                                successMsg();
                                displayLCD();
                            },
                            data:{
                                firstLine: param1,
                                secondLine: param2,
                                duration: param3
                            }
                        });
                    }
                    else if(type == 'Dismiss Alarm')
                    {
                        $.ajax({
                            url: document.URL.replace("?", "") + 'dismissAlarm',
                            type: 'POST',
                            success: function(response){
                                successMsg();
                                displayLCD();
                            },
                            data:{
                                passcode: param1
                            }
                        });
                    }
                })
            }  

            var socket = io();

            // socket.on('message', function(data){
            //     $("#e1").html(data);
            //     console.log(data);
            // });
            socket.on('message', function(data){
                data = JSON.stringify(data);
                console.log(data);
                lcdDisplay(data);
                console.log("display");
            }); 

            // var dataInterval = setInterval(getData, 3000);

            // $('#clearGetData').click(()=>{
            //     clearInterval(dataInterval);
            // })     

            var displayLCD = function(){
                $.ajax({
                    url: document.URL.replace("?", "") + 'getStatus',
                    type: 'GET',
                    success: lcdDisplay
                });
            }

            var actionHistory = function(){
                $.ajax({
                    url: document.URL.replace("?", "") + 'getHistory',
                    type: 'GET',
                    success: displayHistory
                });                
            }


            var successMsg = function(){
                $('#statusMessage').html("Applied successfully!");
                $('#alertSuccessMessage').show();
            }

            var failureMsg = function(){
                $('#statusMessage').html("Fail to execute!");
                $('#alertFailureMessage').show();
            }

            $(document).ready(function() {

                displayLCD();
                actionHistory();

                $('#alertSuccessMessage').hide();
                $('#alertFailureMessage').hide();

                $("#getData").click(()=>{
                    location.reload();
                }); 
                
                $("#motorControlOn").click(()=>{

                    var type = $('#unitType').val();
                    var num = $('#cycle').val();

                    if(num == "")
                    {
                        failureMsg();
                        return;
                    }

                    if(type == "liter")
                        num = num*60*6;
                    else if(type == "time")
                        num = num*6;

                    num = Math.ceil(num);
                    console.log(num);

                    $.ajax({
                        url: document.URL.replace("?", "") + 'updateMotor',
                        type: 'POST',
                        success: function(response){
                            console.log(response);
                            
                            successMsg();
                            $('#cycle').val("");
                            $('#cycle').focus();

                            // $.ajax({
                            //     url: document.URL.replace("?", "") + 'getStatus',
                            //     type: 'GET',
                            //     success: lcdDisplay
                            
                            // });
                        },
                        data:{
                            cycle: num,
                            status: "on"
                        }
                    });

                }); 
                
                $("#motorControlOff").click(()=>{


                    $.ajax({
                        url: document.URL.replace("?", "") + 'updateMotor',
                        type: 'POST',
                        success: function(response){
                            console.log(response);
                            successMsg();
                            $('#cycle').val("");
                            $('#cycle').focus();
                        },
                        data:{
                            cycle: "0",
                            status: "off"
                        }
                    });
                    
                });

                $("#alarmDismiss").click(()=>{

                    if($('#passcode').val() == "")
                    {
                        failureMsg();
                        return;
                    }

                    $.ajax({
                        url: document.URL.replace("?", "") + 'dismissAlarm',
                        type: 'POST',
                        success: function(response){
                            console.log(response);
                            
                            successMsg();
                            $('#passcode').val("");
                            $('#passcode').focus();

                            displayLCD();
                        },
                        data:{
                            passcode: $('#passcode').val()
                        }
                    });
                });

                $("#sendMessage").click(()=>{

                    console.log("1: "+ document.URL.replace("?", ""));
                    $.ajax({
                        url: document.URL.replace("?", "") + 'sendMessage',
                        type: 'POST',
                        success: function(response){
                            console.log(response);
                            
                            // if(response === 'ok')
                            $('#statusMessage').html("Sent message successfully!");
                            $('#message').val("");
                            $('#message').focus();
                            $('#alertMessage').show();

                            console.log("2: "+ document.URL.replace("?", ""));

                            $.ajax({
                                url: document.URL.replace("?", "")+'getStatus',
                                type: 'GET',
                                success: lcdDisplay
                            
                            });

                            successMsg();
                        },
                        data:{
                            firstLine: $('#firstLine').val(),
                            secondLine: $('#secondLine').val(),
                            duration: $('#duration').val()
                        }
                    });

                });


                $("#successMessage").click(()=>{
                    // var div = this.parentElement;
                    // div.style.opacity = "0";
                    // setTimeout(function(){ div.style.display = "none"; }, 600);
                    $('#alertSuccessMessage').hide();
                });
                $("#failureMessage").click(()=>{
                    // var div = this.parentElement;
                    // div.style.opacity = "0";
                    // setTimeout(function(){ div.style.display = "none"; }, 600);
                    $('#alertFailureMessage').hide();
                });
            });

            // var close = document.getElementsByClassName("closebtn");
            // var i;

            // for (i = 0; i < close.length; i++) {
            //     close[i].onclick = function(){
            //         var div = this.parentElement;
            //         div.style.opacity = "0";
            //         setTimeout(function(){ div.style.display = "none"; }, 600);
            //     }
            // }            
               


        </script>
    </head>

    <body>
           
        <div class="tablet">
            <!-- <h3>Panels with Contextual Classes</h3> -->
                <div class="panel-group">
                        <!-- //  // panel-primary -->
                    <div class="panel first-panel"> 
                        <div class="first-panel-heading">GMS Remote Controller</div>
                        <div class="panel-body">
                            <div id = 'lcd' align="center">
                                <!-- <p id = 'firstLine'>Ticker 0123<p> -->
                                <table id="result">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>                
                            </div>    

                            <fieldset id="customer">
                                <!-- <legend>Device Status</legend> -->
                                <div class="formRow">
                                    <div align="right">
                                        
                                        <button id="getData" class="btn btn-primary">Refresh</button>
                                    </div>
                                </div>
                            </fieldset>                               

                            <!-- <h2>Control Menu</h2>
                            <p>To make the tabs toggleable, add the data-toggle="tab" attribute to each link. Then add a .tab-pane class with a unique ID for every tab and wrap them inside a div element with class .tab-content.</p> -->
                            <ul class="nav nav-tabs">
                                <li class="active"><a data-toggle="tab" href="#home">Control Devices</a></li>
                                <li><a data-toggle="tab" href="#menu1">Urgent Message</a></li>
                                <li><a data-toggle="tab" href="#menu2">Action History</a></li>
                                <li><a data-toggle="tab" href="#menu3">About</a></li>
                            </ul>

                            <div class="tab-content">
                                <div id="home" class="tab-pane fade in active">
                                    <!-- <h3>HOME</h3> -->
                                    <br>
                                    <p>This menu provides the options to configure and control the device manually. First of all, you can refer the recommendation numbers derived from GMS machine learning.</p>

                                    
                                    <!--<div id="motorControl"></div>-->
                                    <script type="text/babel" src="./getRecommendations.js"></script>                                      

                                    <br>
                                    <div class="panel-group" id="accordion">
                                        <div class="panel panel-default">
                                            <div class="panel-heading">
                                            <h4 class="panel-title">
                                                <a data-toggle="collapse" data-parent="#accordion" href="#collapse1">Sprinkler</a>
                                            </h4>
                                            </div>
                                            <div id="collapse1" class="panel-collapse collapse in">
                                                <div class="panel-body">
                                                    <form class="form-horizontal">
                                                        <!--react-->
                                                        <p class="col-sm-offset-1 ">Recommendation by GMS calculation</p>
                                                        <div class="col-sm-offset-1 " id="recommendation"></div>
                                                        <br>
                                                        
                                                        <form class="form-inline">
                                                            <div class="form-row">
                                                                <div class="col-sm-offset-1 col-sm-6">
                                                                    <input type="number" class="form-control" id="cycle" min=0 placeholder="Enter your number" required>
                                                                </div>
                                                                <select class="form-control" id="unitType" >
                                                                    <option value="liter">Liter (l)</option>
                                                                    <option value="time">Time (minute)</option>
                                                                    <option value="cycle" selected>Cycles (times)</option>
                                                                </select>
                                                            </div>
                                                        </form>
                                                        <br>

                                                        <div class="form-group">        
                                                            <div class="col-sm-offset-1 col-sm-8">
                                                                <button type="submit" class="btn btn-primary" id="motorControlOn">Start Watering</button>
                                                                <button type="submit" class="btn btn-primary" id="motorControlOff">Stop Watering</button>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">        
                                                            <div class="col-sm-offset-3 col-sm-8">
                                                                <!-- <span><img src="./resources/images/watering/b0.png" height="35" width="35" alt="Image of a watering." /></span>         -->
                                                            </div>
                                                        </div>
                                                    </form>                                         
                                                </div>
                                            </div>
                                        </div>
                                        <div class="panel panel-default">
                                            <div class="panel-heading">
                                            <h4 class="panel-title">
                                                <a data-toggle="collapse" data-parent="#accordion" href="#collapse2">Alarm</a>
                                            </h4>
                                            </div>
                                            <div id="collapse2" class="panel-collapse collapse">
                                                <div class="panel-body">
                                                    <form class="form-horizontal">
                                                        <div class="form-group">
                                                                <label class="control-label col-sm-3" for="capturedImage">Captured image</label>
                                                                <div class="col-sm-8">
                                                                    <!-- <span><img src="./resources/images/watering/b1.png" height="35" width="35" alt="Image of a watering." /></span> -->
                                                                    <div id="app"></div>
                                                                </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label class="control-label col-sm-3" for="passcode">Passcode</label>
                                                            <div class="col-sm-8">
                                                                <input type="password" class="form-control" id="passcode" placeholder="Enter your code" required>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">        
                                                            <div class="col-sm-offset-3 col-sm-8">
                                                                <button type="submit" class="btn btn-primary" id="alarmDismiss">Dismiss Alarm</button>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">        
                                                            <div class="col-sm-offset-3 col-sm-8">
                                                                <!-- <span><img src="./resources/images/watering/b0.png" height="35" width="35" alt="Image of a watering." /></span>         -->
                                                            </div>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    </div>
                                    <div id="menu1" class="tab-pane fade">
                                      <!-- <h3>Menu 1</h3> -->
                                        <br>
                                        <p>You can send an urgent message to the LCD panel of GMS device. Each line can have 20 characters as the maximum length. </p>
                                        <br>
                                        <div class="panel-group" id="accordion">
                                            <div class="panel panel-default">
                                                <div class="panel-heading">
                                                <h4 class="panel-title">
                                                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse1">Message</a>
                                                </h4>
                                                </div>
                                                <div id="collapse1" class="panel-collapse collapse in">
                                                    <div class="panel-body">
                                                        <form class="form-horizontal">
                                                            <div class="form-group">
                                                                <label class="control-label col-sm-3" for="firstLine">First Line:</label>
                                                                <div class="col-sm-8">
                                                                    <input type="text" class="form-control" id="firstLine" maxlength=20 placeholder="Enter your message">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label class="control-label col-sm-3" for="secondLine">Second Line:</label>
                                                                <div class="col-sm-8">          
                                                                    <input type="text" class="form-control" id="secondLine" maxlength=20 placeholder="Enter your message">
                                                                </div>
                                                            </div>
                
                                                            <div class="form-group">
                                                                <label class="control-label col-sm-3" for="duration">Dureation:</label>
                                                                <div class="col-sm-8">          
                                                                    <select class="form-control" id="duration" >
                                                                        <option value="1">1 second</option>
                                                                        <option value="2" selected>2 seconds</option>
                                                                        <option value="3">3 seconds</option>
                                                                        <option value="4">4 seconds</option>
                                                                        <option value="5">5 seconds</option>
                                                                    </select>
                                                                </div>
                                                            </div>

                                                            <br>
                
                                                            <div class="form-group">        
                                                                <div class="col-sm-offset-3 col-sm-8">
                                                                    <button type="submit" class="btn btn-primary" id="sendMessage">Send Message</button>
                                                                </div>
                                                            </div>
                                                        </form>                   
                                                    </div>
                                                </div>
                                            </div>
                                        </div>                                                                               
                                    </div>

                                    <div id="menu2" class="tab-pane fade">
                                      <!-- <h3>Menu 2</h3> -->
                                      <br>
                                      <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam.</p>
                                      <br>
                                      <div class="panel-group" id="accordion">
                                          <div class="panel panel-default">
                                              <div class="panel-heading">
                                              <h4 class="panel-title">
                                                  <a data-toggle="collapse" data-parent="#accordion" href="#collapse1">Last 10 Actions List</a>
                                              </h4>
                                              </div>
                                              <div id="collapse1" class="panel-collapse collapse in">
                                                  <div class="panel-body">
                                                      <form class="form-horizontal">
                                                          <div class="form-group">
                                                              <div class="col-sm-12">
                                                                <table id="actionHistory" class="table table-striped">
                                                                    <thead></thead>
                                                                    <tbody>
                                                                        <tr><td></td></tr>
                                                                    </tbody>
                                                                </table>  
                                                              </div>
                                                          </div>   
                                                      </form>                                         
                                                  </div>
                                              </div>
                                          </div>
                                      </div>                                    
                                    </div>
                                    <div id="menu3" class="tab-pane fade">

                                    <br>
                                    <p>This is the definition about GMS remote controller for GMS. </p>
                                    <br>
                                    <div class="panel-group" id="accordion">
                                        <div class="panel panel-default">
                                            <div class="panel-heading">
                                            <h4 class="panel-title">
                                                <a data-toggle="collapse" data-parent="#accordion" href="#collapse1">GMS Remote Controller</a>
                                            </h4>
                                            </div>
                                            <div id="collapse1" class="panel-collapse collapse in">
                                                <div class="panel-body">
                                                    <form class="form-horizontal">
                                                        <div class="form-group">
                                                            <div class="col-sm-12">
                                                                GMS is a short expression for Gardening Management System. 
                                                                This is an integrated solution program to provide ease
                                                                of plant management with the environmental parameters such as temperature, humidity,
                                                                and daily weather information.User can check the status on their web browser out and the
                                                                system recommends an appropriate action as the situation. 
                                                                <br><br> 
                                                                This application helps people who are interested in the advanced management of gardening to monitor their plant
                                                                more efficiently and flexibly. Moreover, this will be suitable for implementing and
                                                                extending various programming language and network knowledge which we have learnt.    
                                                                <br><br>
                                                                Copyright Douglas College CSIS4280 Â© 2019. 
                                                                All rights reserved.
                                                            </div>
                                                        </div>   
                                                    </form>                                         
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <!-- <script>
                                var sprinklerArr = new Array(3);
                                var curSprinkler = 0; // holds the images being shown
                    
                                // preload the image to the array
                                for(let i = 0; i < sprinklerArr.length; i++)
                                {
                                    sprinklerArr[i] = "./resources/images/watering/b" + i + ".png";
                                }
                    
                                function runningSprinkler()
                                {
                                    var dispImage = document.getElementsByTagName("img");
                    
                                    curSprinkler = curSprinkler % sprinklerArr.length;
                                    dispImage[0].src = sprinklerArr[curSprinkler];
                                    curSprinkler++;
                                }
                    
                                // setInterval
                                setInterval(runningSprinkler, 1000);
                            </script> -->

                            <!-- <fieldset id="customer">
                            
                                <legend>Control Menu</legend>
                            

                                <hr>
                                

                                </div>

                            </fieldset>          

                            
                            <hr>
                            <div id="originaldata"></div>
                            
                            <div id="JSONParsedata"></div-->
                            

 
                        </div> 


                    </div>

                    <div id = "alertSuccessMessage" class="alert success">
                        <span id="successMessage" class="closebtn">&times;</span>  
                        <p id="statusMessage">Applied successfully</p>
                    </div>

                    <div id = "alertFailureMessage" class="alert">
                        <span id="failureMessage" class="closebtn">&times;</span>  
                        <p id="statusMessage">Fail to execute</p>
                    </div>
                </div>
            </div>
        </div>
    </body>

</html>